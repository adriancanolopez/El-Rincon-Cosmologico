---
export const prerender = false;
import Layout from "../../../layouts/Layout.astro";
import { getNews } from "../../../api/NewsRequests";
import NewsCard from "../../../components/admin/news/NewsCard.astro";

const token  = Astro.cookies.get('token')?.value as string;

const newsRequest = await getNews(token);
const noNews = newsRequest.ok && newsRequest.data.length === 0;
const allNews = newsRequest.ok ? newsRequest.data : [];

const { user } = Astro.locals;
---

<Layout title="Noticias">
    <div class="flex flex-col items-center gap-2 md:grid md:grid-cols-[1fr_auto_1fr] py-4">
        <h1 class="md:col-start-2 text-2xl font-bold text-center">Todas las Noticias</h1>
        <a href="/admin/news/create" class=" md:col-start-3 md:justify-self-end md:mt-4 md:mr-4 px-4 py-2 bg-blue-600 rounded-md hover:cursor-pointer">
            <button class="hover:cursor-pointer">Crear Noticia</button>
        </a>
    </div>
    {
        noNews && (
            <p class="text-center my-32">No hay noticias.</p>
        )
    }
    <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8 p-4" id="news">
        {
            allNews.map(news => {
                return (
                    <NewsCard news={news} role={user!.role}/>
                )
            })
        }
    </section>
</Layout>

<script>
    import { deleteNews } from '../../../api/NewsRequests';
    import type { DeleteResponse } from '../../../types/news.types';

    const deleteIcons: NodeListOf<SVGElement> = document.querySelectorAll(".delete-icon");

    deleteIcons.forEach(deleteIcon => {
        deleteIcon.addEventListener('click', async function() {
            const idNews = deleteIcon.id.split("-").pop();
            const response: DeleteResponse = await deleteNews(idNews as string);

            console.log(response);

            if (response.ok) {
                document.querySelector(`#news-${idNews}`)?.remove();
            }

        });
    });
</script>
---
import Layout from "../../../layouts/Layout.astro";
import "../../../styles/forms.css";
import { getNews } from "../../../api/NewsRequests";
import formatDate from "../../../utils/formatDate";

export async function getStaticPaths() {
    const newsRequest = await getNews();
    const allNews = newsRequest.ok ? newsRequest.data : [];

    return allNews.map((news) => ({
        params: {id: news._id},
        props: { news }
    }));
}

const { news } = Astro.props;


---

<Layout title={`Noticia - ${news.title}`}>
    <div class="grid grid-cols-[1fr_auto_1fr] items-center">
        <h1 class="col-start-2 text-xl text-center" id="form-title">{news.title}</h1>
        <a href="/admin/news/" class="col-start-3 justify-self-end mr-4 mt-2 p-2 bg-blue-600 rounded-md hover:cursor-pointer">
            <button class="hover:cursor-pointer">Volver</button>
        </a>
    </div>
    <section class="flex flex-col items-center">
        <div class="flex flex-col items-center mb-2">
            <span>
                <span class="font-bold">Creación: </span>
                {formatDate(news.createdAt as string)}
            </span>
            <span>
                <span class="font-bold">Última modificación: </span>
                {formatDate(news.updatedAt as string)}
            </span>
        </div>
        <form action="" method="post" class="form" id="updateForm" enctype="multipart/form-data">
            <div class="form-field">
                <label for="title">Título:</label>
                <input type="text" name="title" id="title" value={news.title} placeholder="Título de la noticia..."/>
            </div>
            <div class="form-field">
                <label for="description">Descripción:</label>
                <textarea name="description" id="description" rows="10" placeholder="Descripción de la noticia...">{news.description}</textarea>
            </div>
            <div class="flex flex-col items-center">
                <img src={`http://localhost:3000/uploads/news/${news.imageUrl}`} alt="Imagen de la noticia" class="w-2/5 rounded-sm"/>
            </div>
            <div class="form-field">
                <label for="image">Cambiar imagen:</label>
                <input type="file" name="image" id="image">
            </div>
            <div class="flex flex-row gap-2 p-2">
                <label for="published">Publicar:</label>
                <input type="checkbox" name="published" class="checkbox" id="published" checked={news.published}>
            </div>
            <div class="form-field items-center">
                <input type="submit" value="Actualizar Noticia" id="submit">
                <span id="message" class="text-md"></span>
            </div>
        </form>
    </section>
</Layout>

<script>
    import { updateNews, updateNewsWithImage } from '../../../api/NewsRequests';
    import type { UpdateResponse } from '../../../types/news.types';


    const form = document.querySelector('#updateForm') as HTMLFormElement;


    form.addEventListener('submit', async function(event: Event) {
        event.preventDefault();

        const titleInput = document.querySelector('#title') as HTMLInputElement;
        const descriptionInput = document.querySelector('#description') as HTMLTextAreaElement;
        const imageInput = document.querySelector('#image') as HTMLInputElement;
        const publishedCheckbox = document.querySelector('#published') as HTMLInputElement;

        const messageElement = document.querySelector('#message') as HTMLSpanElement;

        const newsId = window.location.href.split("/").pop();
        const title = titleInput.value;
        const description = descriptionInput.value;
        const published = publishedCheckbox.checked;

        const image: File | null = imageInput.files && imageInput.files.length > 0 && imageInput.files[0].size > 0 ? imageInput.files[0] : null;

        let response: UpdateResponse;

        if (image) {
            // Se quiere cambiar la imagen
            response = await updateNewsWithImage({_id: newsId, title, description, imageUrl: image, published});

        }
        else {
            response = await updateNews({_id: newsId, title, description, published});
        }

        if (response.ok) {
            messageElement.classList.remove('error-message');
            messageElement.classList.add('success-message');
            messageElement.innerHTML = "Noticia editada correctamente.";
        }
        else {
            messageElement.classList.remove('success-message');
            messageElement.classList.add('error-message');
            messageElement.innerHTML = response.message;
        }

    });
</script>